<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
</head>

<body>
    <div class="wrapper">
        <div id="mySidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>Menu</h3>
                <button class="toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a>
            <a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a>
            <a href="#"><i class="fas fa-cog"></i> <span>Settings</span></a>
        </div>
        <div class="content">
            <div class="newsidebar">
                <div class="container">
                    <h2>Devices</h2>
                    <hr>
                    <div class="devices">
                        <div class="device">
                            <div class="color"></div>
                            <div class="details">
                                <h3 class="name">Device Name</h3>
                                <p class="last">Last Location: lat: 12.99, long: 75.3403</p>
                                <p class="description">D this isasdadasd</p>
                                <div class="editload">
                                    <a class="edit" onclick="edit(event)" href="#">Edit</a>
                                    <a href="#" class="load" onclick="check()"><img src="https://img.icons8.com/ios/50/000000/refresh.png" alt=""></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div id="coordinates" class="coordinates">Hover over the map to see coordinates</div> -->
            <div id="map"></div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
</body>
</html>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBE0SqJqJ24rfDltYeXg71J4trb8tsXHZY",
      authDomain: "csas-90a2d.firebaseapp.com",
      databaseURL: "https://csas-90a2d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "csas-90a2d",
      storageBucket: "csas-90a2d.appspot.com",
      messagingSenderId: "859944009411",
      appId: "1:859944009411:web:9cd24338bde6a9d9e72c76"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    import { getDatabase, ref,child, set, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    
    const database = getDatabase(app);

    window.onload = function() {
        loadData();
    };

    function loadData() {
        const dbref = ref(database);
        get(child( dbref, 'location')).then((snapshot) => {
            if (snapshot.exists()) {
                lat = snapshot.val().latitude;
                long = snapshot.val().longitude;
                rand = snapshot.val().randomNumber;
                console.log(rand);
            }
            else {
                console.log('No data available');
            }
        }).catch((error) => {
            console.error(error);
        });
    }

    let lat = 0;
    let long= 0 ;
    let rand=0;
    if ('Notification' in window && navigator.serviceWorker) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Notification permission granted.');
            } else {
                console.log('Notification permission denied.');
            }
        });
    }
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
            console.log('Service Worker registration failed:', error);
        });
    }
    // Initialize the map with center coordinates and zoom level
    var map = L.map('map').setView([lat, long], 13);
    
    // Add a tile layer from OpenStreetMap
    var tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    // Initialize a variable for a marker (currently null)
    var marker = null;
    var bounds = null;
    // Create a feature group for drawn items (e.g., shapes)
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    map.on('draw:created', function (e) {
        var layer = e.layer;
        var boundary = e.layer.getBounds(); // Use getBounds() to ensure compatibility with other shapes
        bounds = boundary; // Assign directly without stringifying/parsing
        drawnItems.addLayer(layer);
        console.log("Layer created and added to drawnItems:", layer);
    });
    
    // Handle the deletion of drawn items
    map.on('draw:deleted', function (e) {
        var deletedLayers = e.layers;
        deletedLayers.eachLayer(function (layer) {
            drawnItems.removeLayer(layer); // Remove each deleted layer from drawnItems
            console.log("Layer deleted and removed from drawnItems:", layer);
        });
    });
    // Initialize a draw control to allow drawing/editing shapes
    var drawControl = new L.Control.Draw({
        draw: {
            polyline: false,
            polygon: false,
            circle: false,
            circlemarker: false,
            marker: false,
        },
        edit: {
            featureGroup: drawnItems  // Bind the draw control to the drawn items feature group
        }
    });
    map.addControl(drawControl);
    
    function isMarkerInRectangle(markerPosition, rectangleBounds) {
        const { lat, lng } = markerPosition;
        const { _southWest, _northEast } = rectangleBounds;
    
        console.log(_southWest);
    
        return (
            lat >= _southWest.lat.toFixed(2) &&
            lat <= _northEast.lat.toFixed(2) ||
            lng >= _southWest.lng.toFixed(2) &&
            lng <= _northEast.lng.toFixed(2)
        );
    }
    
    // Example usage
    function check(){
        const isInRectangle = isMarkerInRectangle({lat,long}, bounds);
        // alert("Is marker inside rectangle?", isInRectangle);
        console.log("Is marker inside rectangle?", isInRectangle);
        if (!isInRectangle) {
            notify();
        }
        console.log("Drawn Items: ",drawnItems);
    }
    
    
    
    
    function edit(event){
        event.preventDefault();
        const deviceElement = event.target.closest('.device');
        const name = deviceElement.querySelector('.name').textContent.trim();
        const description = deviceElement.querySelector('.description').textContent.trim();
        
        // Prompt for new name and description
        const newName = prompt('Enter new device name:', name);
        const newDescription = prompt('Enter new description:', description);
        
        // Update device details if newName and newDescription are not null
        if (newName !== null && newDescription !== null) {
            deviceElement.querySelector('.name').textContent = newName;
            deviceElement.querySelector('.description').textContent = newDescription;
            saveToDeviceStorage(newName, newDescription);
        }
    }
    function saveToDeviceStorage(name, description) {
        const deviceData = {
            name,
            description
        };
        localStorage.setItem('deviceData', JSON.stringify(deviceData));
    }
    
    function loadFromDeviceStorage() {
        const deviceDataJSON = localStorage.getItem('deviceData');
        if (deviceDataJSON) {
            const deviceData = JSON.parse(deviceDataJSON);
            return deviceData;
        }
        return null;
    }
    const storedDeviceData = loadFromDeviceStorage();
    if (storedDeviceData) {
        document.querySelector('.name').textContent = storedDeviceData.name;
        document.querySelector('.description').textContent = storedDeviceData.description;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.querySelector('.toggle-btn');
        const sidebar = document.getElementById('mySidebar');
        const content = document.querySelector('.content');
        const name_of_device = document.querySelector('.name');
        
        name_of_device.addEventListener('click', function(){
            var newLatLng = [12.99218, 75.3403]; // New marker position
            if (marker) {
                // Marker exists, so update its position
                marker.setLatLng(newLatLng).update();
            } else {
                // Marker doesn't exist, so create a new one
                marker = L.marker(newLatLng).addTo(map);
                marker.bindPopup("Camera focused here").openPopup(); // Optional popup message
            }
            
            // Fly to the new position with smooth transition
            map.flyTo(newLatLng, 18, {
                duration: 1
            });
            marker.bindPopup("Camera focused here").openPopup();
        })
        
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('closed');
            content.classList.toggle('expanded');
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('closed');
                content.classList.remove('expanded');
            }
        });
    });
    
        //Notification part
        
        function notify() {
            navigator.serviceWorker.ready.then(registration => {
        registration.showNotification('Hello, world!', {
            body: 'This is a test notification.',
            icon: '/path/to/icon.png',
            tag: 'test-notification'
        });
    });
            console.log("clicked2");
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            } else {
                var notification = new Notification(
                    "Hello, World!",
                    {
                        body: "Samartha has left the predefined bounds",
                        // tag: "Samartha has left the predefined bounds"
                    }
                );
            }
        } </script>

<script>
    
</script>
